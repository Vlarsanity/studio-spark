<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Photo Booth - Capture Amazing Moments</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"/>
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      --shadow-light: 0 10px 30px rgba(0, 0, 0, 0.1);
      --shadow-heavy: 0 20px 40px rgba(0, 0, 0, 0.15);
      --border-radius: 20px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    body {
      background: var(--primary-gradient);
      min-height: 100vh;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      color: white;
    }

    .camera-container {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-heavy);
      border: 1px solid rgba(255, 255, 255, 0.2);
      padding: 2rem;
      margin: 2rem auto;
      max-width: 800px;
      color: #2d3748;
    }

    .session-header {
      text-align: center;
      margin-bottom: 2rem;
      padding: 1.5rem;
      background: var(--primary-gradient);
      color: white;
      border-radius: var(--border-radius);
      border: 1px solid rgba(255, 255, 255, 0.2);
      position: relative;
      overflow: hidden;
    }

    .session-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="20" cy="20" r="1" fill="white" opacity="0.1"/><circle cx="80" cy="40" r="1" fill="white" opacity="0.1"/><circle cx="40" cy="80" r="1" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
      pointer-events: none;
    }

    .session-header h2 {
      font-weight: 800;
      margin-bottom: 0.5rem;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    #camera-video {
      width: 100%;
      max-width: 500px;
      height: auto;
      border-radius: var(--border-radius);
      border: 4px solid white;
      box-shadow: var(--shadow-heavy);
      transition: var(--transition);
      background: #f8f9fa;
    }

    #camera-video:hover {
      transform: scale(1.02);
    }

    .camera-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1rem;
      margin-top: 1.5rem;
      flex-wrap: wrap;
    }

    #capture-btn {
      background: var(--secondary-gradient);
      border: none;
      border-radius: 50px;
      padding: 1rem 2rem;
      font-size: 1.2rem;
      font-weight: 700;
      color: white;
      transition: var(--transition);
      box-shadow: var(--shadow-light);
      text-transform: uppercase;
      letter-spacing: 1px;
      position: relative;
      overflow: hidden;
    }

    #capture-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    #capture-btn:hover::before {
      left: 100%;
    }

    #capture-btn:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-heavy);
    }

    #switch-camera-btn {
      border-radius: 50%;
      width: 60px;
      height: 60px;
      border: 3px solid white;
      background: rgba(255, 255, 255, 0.9);
      transition: var(--transition);
      box-shadow: var(--shadow-light);
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #switch-camera-btn:hover {
      transform: rotate(180deg);
      background: var(--primary-gradient);
      color: white;
      border-color: transparent;
    }

    .countdown-display {
      text-align: center;
      margin: 2rem 0;
    }

    #countdown {
      font-size: clamp(2rem, 8vw, 4rem);
      font-weight: 800;
      color: #667eea;
      text-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
      margin: 1rem 0;
      transition: var(--transition);
    }

    #countdown.pulse {
      animation: pulse 0.5s ease-in-out;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    .photo-preview-section {
      margin: 2rem 0;
      text-align: center;
    }

    .photo-preview-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 1rem;
    }

    #photo-preview {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 1rem;
      min-height: 120px;
      padding: 1rem;
      background: rgba(102, 126, 234, 0.05);
      border-radius: var(--border-radius);
      border: 2px dashed rgba(102, 126, 234, 0.3);
    }

    .photo-preview-item {
      width: 100px;
      height: 100px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-light);
      transition: var(--transition);
      border: 3px solid white;
      position: relative;
      overflow: hidden;
    }

    .photo-preview-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--success-gradient);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .photo-preview-item:hover {
      transform: scale(1.1) rotate(2deg);
    }

    .photo-preview-item:hover::before {
      opacity: 0.2;
    }

    .photo-preview-empty {
      display: flex;
      align-items: center;
      justify-content: center;
      color: #9ca3af;
      font-size: 0.9rem;
      font-style: italic;
    }

    .next-button {
      background: var(--success-gradient);
      border: none;
      border-radius: 15px;
      padding: 1rem 3rem;
      font-size: 1.2rem;
      font-weight: 700;
      color: white;
      transition: var(--transition);
      text-transform: uppercase;
      letter-spacing: 1px;
      position: relative;
      overflow: hidden;
      margin-top: 2rem;
    }

    .next-button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .next-button:hover::before {
      left: 100%;
    }

    .next-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(79, 172, 254, 0.4);
    }

    .next-button:disabled {
      background: #e9ecef;
      color: #6c757d;
      transform: none;
      box-shadow: none;
      cursor: not-allowed;
    }

    .next-button:disabled::before {
      display: none;
    }

    .status-message {
      padding: 1rem;
      border-radius: var(--border-radius);
      margin: 1rem 0;
      font-weight: 500;
      text-align: center;
      transition: var(--transition);
    }

    .status-message.success {
      background: rgba(79, 172, 254, 0.1);
      color: #0066cc;
      border: 2px solid rgba(79, 172, 254, 0.3);
    }

    .status-message.error {
      background: rgba(245, 87, 108, 0.1);
      color: #c53030;
      border: 2px solid rgba(245, 87, 108, 0.3);
    }

    .status-message.info {
      background: rgba(102, 126, 234, 0.1);
      color: #4c51bf;
      border: 2px solid rgba(102, 126, 234, 0.3);
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      overflow: hidden;
      margin: 1rem 0;
    }

    .progress-fill {
      height: 100%;
      background: var(--success-gradient);
      width: 0%;
      transition: width 0.3s ease;
      border-radius: 10px;
    }

    .shot-counter {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      margin: 1rem 0;
    }

    .shot-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transition: var(--transition);
    }

    .shot-indicator.completed {
      background: var(--success-gradient);
      transform: scale(1.2);
    }

    .shot-indicator.current {
      background: var(--secondary-gradient);
      transform: scale(1.4);
      animation: pulse 1s infinite;
    }

    .camera-flash {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: white;
      opacity: 0;
      pointer-events: none;
      z-index: 9999;
    }

    .instructions {
      text-align: center;
      padding: 1.5rem;
      background: rgba(79, 172, 254, 0.1);
      border-radius: var(--border-radius);
      margin: 1rem 0;
      border: 2px solid rgba(79, 172, 254, 0.2);
    }

    .instructions h4 {
      color: #0066cc;
      font-weight: 700;
      margin-bottom: 1rem;
    }

    .instructions ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .instructions li {
      padding: 0.5rem 0;
      color: #2d3748;
      font-weight: 500;
    }

    .instructions li::before {
      content: 'üì∏';
      margin-right: 0.5rem;
    }

    .floating-elements {
      position: absolute;
      width: 100%;
      height: 100%;
      overflow: hidden;
      pointer-events: none;
      top: 0;
      left: 0;
    }

    .floating-icon {
      position: absolute;
      font-size: 1.5rem;
      opacity: 0.1;
      animation: float 8s ease-in-out infinite;
      color: white;
    }

    .floating-icon:nth-child(1) { top: 10%; left: 10%; animation-delay: 0s; }
    .floating-icon:nth-child(2) { top: 20%; right: 15%; animation-delay: 2s; }
    .floating-icon:nth-child(3) { bottom: 30%; left: 20%; animation-delay: 4s; }
    .floating-icon:nth-child(4) { bottom: 20%; right: 10%; animation-delay: 6s; }

    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      25% { transform: translateY(-15px) rotate(2deg); }
      50% { transform: translateY(-10px) rotate(-2deg); }
      75% { transform: translateY(-20px) rotate(1deg); }
    }

    @media (max-width: 768px) {
      .camera-container {
        margin: 1rem;
        padding: 1.5rem;
      }

      .camera-controls {
        flex-direction: column;
        gap: 1rem;
      }

      #capture-btn {
        width: 100%;
        max-width: 300px;
      }

      #switch-camera-btn {
        width: 50px;
        height: 50px;
      }

      .photo-preview-item {
        width: 80px;
        height: 80px;
      }

      .instructions {
        padding: 1rem;
      }
    }

    @media (max-width: 480px) {
      .session-header {
        padding: 1rem;
      }

      .session-header h2 {
        font-size: 1.5rem;
      }

      #countdown {
        font-size: 2.5rem;
      }

      .photo-preview-item {
        width: 70px;
        height: 70px;
      }
    }
  </style>
</head>
<body>
  <!-- Floating Background Elements -->
  <div class="floating-elements">
    <div class="floating-icon">üì∏</div>
    <div class="floating-icon">üé≠</div>
    <div class="floating-icon">‚ú®</div>
    <div class="floating-icon">üåü</div>
  </div>

  <!-- Camera Flash Effect -->
  <div class="camera-flash" id="cameraFlash"></div>

  <div class="container py-3">
    
    <!-- Session Header -->
    <div class="session-header">
      <h2>üì∏ Photo Session in Progress</h2>
      <p id="template-info" class="mb-0">Get ready to create amazing memories!</p>
      
      <!-- Progress Bar -->
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      
      <!-- Shot Counter -->
      <div class="shot-counter" id="shotCounter">
        <!-- Will be populated by JavaScript -->
      </div>
    </div>

    <!-- Main Camera Container -->
    <div class="camera-container">
      
      <!-- Instructions -->
      <div class="instructions">
        <h4>üìã How to Take Great Photos</h4>
        <ul>
          <li>Look directly at the camera</li>
          <li>Make sure you're well-lit</li>
          <li>Get ready for the countdown</li>
          <li>Have fun and be creative!</li>
        </ul>
      </div>

      <!-- Camera Feed Area -->
      <div class="text-center mb-4" id="camera-container">
        <!-- Camera video will be inserted here by JavaScript -->
      </div>

      <!-- Countdown Display -->
      <div class="countdown-display">
        <div id="countdown" class="display-3 fw-bold">Ready to start? üé¨</div>
      </div>

      <!-- Status Messages -->
      <div id="status-message" class="status-message" style="display: none;"></div>

      <!-- Photo Preview Section -->
      <div class="photo-preview-section">
        <div class="photo-preview-title">üì∑ Your Photos</div>
        <div id="photo-preview" class="photo-preview-empty">
          <div class="d-flex align-items-center justify-content-center w-100">
            <span>Photos will appear here as you take them...</span>
          </div>
        </div>
      </div>

      <!-- Next Button -->
      <div class="text-center">
        <button id="nextBtn" class="next-button" disabled>
          üé® Continue to Editor
        </button>
        
        <div class="mt-3">
          <a href="index.html" class="btn btn-outline-secondary">
            ‚Üê Start Over
          </a>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Enhanced Camera JavaScript with better UI integration
    class EnhancedPhotoboothCamera {
      constructor() {
        this.video = null;
        this.canvas = null;
        this.context = null;
        this.stream = null;
        this.isInitialized = false;
        this.constraints = {
          video: {
            width: { ideal: 1280 },
            height: { ideal: 720 },
            facingMode: 'user'
          },
          audio: false
        };
        
        // Get session data
        this.selectedLayout = localStorage.getItem("selectedLayout");
        this.userEmail = localStorage.getItem("userEmail");
        this.shotsToTake = parseInt(this.selectedLayout, 10) || 4;
        this.shotsTaken = 0;
        this.photos = [];
        
        this.init();
      }

      async init() {
        // Check for session data
        if (!this.selectedLayout || !this.userEmail) {
          this.showError("Missing session data. Please start again.");
          setTimeout(() => {
            window.location.href = "index.html";
          }, 3000);
          return;
        }

        try {
          this.setupElements();
          this.attachEventListeners();
          this.updateSessionInfo();
          this.createShotIndicators();
          await this.startCamera();
          this.isInitialized = true;
          console.log('Enhanced camera initialized successfully');
        } catch (error) {
          console.error('Failed to initialize camera:', error);
          this.showError('Camera initialization failed. Please check your camera permissions.');
        }
      }

      setupElements() {
        // Get existing UI elements
        this.templateInfo = document.getElementById("template-info");
        this.countdownEl = document.getElementById("countdown");
        this.photoPreview = document.getElementById("photo-preview");
        this.nextBtn = document.getElementById("nextBtn");
        this.progressFill = document.getElementById("progressFill");
        this.shotCounter = document.getElementById("shotCounter");
        this.statusMessage = document.getElementById("status-message");
        
        // Setup canvas for photo capture
        this.canvas = document.createElement('canvas');
        this.canvas.style.display = 'none';
        document.body.appendChild(this.canvas);
        this.context = this.canvas.getContext('2d');
      }

      updateSessionInfo() {
        if (this.templateInfo) {
          this.templateInfo.innerHTML = `
            <strong>üìß ${this.userEmail}</strong> ‚Ä¢ 
            <strong>üì∏ ${this.selectedLayout} Shots Template</strong>
          `;
        }
      }

      createShotIndicators() {
        if (this.shotCounter) {
          this.shotCounter.innerHTML = '';
          for (let i = 0; i < this.shotsToTake; i++) {
            const indicator = document.createElement('div');
            indicator.className = 'shot-indicator';
            indicator.id = `shot-${i}`;
            this.shotCounter.appendChild(indicator);
          }
        }
      }

      updateShotIndicators() {
        for (let i = 0; i < this.shotsToTake; i++) {
          const indicator = document.getElementById(`shot-${i}`);
          if (indicator) {
            indicator.classList.remove('completed', 'current');
            if (i < this.shotsTaken) {
              indicator.classList.add('completed');
            } else if (i === this.shotsTaken) {
              indicator.classList.add('current');
            }
          }
        }
      }

      updateProgress() {
        const progress = (this.shotsTaken / this.shotsToTake) * 100;
        if (this.progressFill) {
          this.progressFill.style.width = `${progress}%`;
        }
      }

      async startCamera() {
        try {
          this.stream = await navigator.mediaDevices.getUserMedia(this.constraints);
          
          // Create video element
          this.video = document.createElement('video');
          this.video.id = 'camera-video';
          this.video.autoplay = true;
          this.video.playsInline = true;
          this.video.muted = true;
          this.video.srcObject = this.stream;

          // Create camera controls
          const cameraContainer = document.getElementById('camera-container');
          cameraContainer.innerHTML = '';
          cameraContainer.appendChild(this.video);

          const controlsDiv = document.createElement('div');
          controlsDiv.className = 'camera-controls';

          // Capture button
          this.captureButton = document.createElement('button');
          this.captureButton.id = 'capture-btn';
          this.captureButton.innerHTML = 'üì∏ Take Photo';
          this.captureButton.style.display = 'none';

          // Switch camera button
          const switchBtn = document.createElement('button');
          switchBtn.id = 'switch-camera-btn';
          switchBtn.innerHTML = 'üîÑ';
          switchBtn.title = 'Switch Camera';

          controlsDiv.appendChild(this.captureButton);
          controlsDiv.appendChild(switchBtn);
          cameraContainer.appendChild(controlsDiv);

          await new Promise((resolve) => {
            this.video.onloadedmetadata = resolve;
          });

          this.adjustCanvasSize();
          this.attachCameraEventListeners();
          
          // Start the photo session
          setTimeout(() => this.startPhotoSession(), 1000);
          
        } catch (error) {
          console.error('Error accessing camera:', error);
          let errorMessage = 'Unable to access camera. ';
          
          if (error.name === 'NotAllowedError') {
            errorMessage += 'Please allow camera permissions and reload the page.';
          } else if (error.name === 'NotFoundError') {
            errorMessage += 'No camera found on this device.';
          } else {
            errorMessage += 'Please check your camera settings.';
          }
          
          this.showError(errorMessage);
          throw error;
        }
      }

      attachCameraEventListeners() {
        if (this.captureButton) {
          this.captureButton.addEventListener('click', () => this.capturePhoto());
        }

        const switchBtn = document.getElementById('switch-camera-btn');
        if (switchBtn) {
          switchBtn.addEventListener('click', () => this.switchCamera());
        }
      }

      attachEventListeners() {
        if (this.nextBtn) {
          this.nextBtn.addEventListener('click', () => this.proceedToEditor());
        }
      }

      startPhotoSession() {
        this.showStatus('Camera ready! Photo session starting...', 'info');
        this.updateShotIndicators();
        setTimeout(() => {
          this.startCountdown();
        }, 2000);
      }

      startCountdown() {
        if (this.shotsTaken >= this.shotsToTake) {
          this.completeSession();
          return;
        }

        let count = 3;
        this.countdownEl.textContent = `Photo ${this.shotsTaken + 1} of ${this.shotsToTake} - Get Ready: ${count}`;
        this.countdownEl.classList.add('pulse');
        this.captureButton.style.display = 'none';
        
        const interval = setInterval(() => {
          count--;
          this.countdownEl.classList.add('pulse');
          
          if (count > 0) {
            this.countdownEl.textContent = `Photo ${this.shotsTaken + 1} of ${this.shotsToTake} - Get Ready: ${count}`;
          } else if (count === 0) {
            this.countdownEl.textContent = 'Smile! üì∏';
            this.captureButton.style.display = 'inline-block';
          } else {
            clearInterval(interval);
            setTimeout(() => {
              this.capturePhoto();
            }, 1000);
          }
          
          setTimeout(() => {
            this.countdownEl.classList.remove('pulse');
          }, 500);
        }, 1000);
      }

      adjustCanvasSize() {
        if (this.video.videoWidth && this.video.videoHeight) {
          this.canvas.width = this.video.videoWidth;
          this.canvas.height = this.video.videoHeight;
        }
      }

      async capturePhoto() {
        if (!this.isInitialized || !this.video.videoWidth) {
          this.showError('Camera not ready. Please wait a moment and try again.');
          return;
        }

        try {
          // Draw current video frame to canvas
          this.context.drawImage(this.video, 0, 0, this.canvas.width, this.canvas.height);
          
          // Convert to data URL
          const photoDataUrl = this.canvas.toDataURL('image/jpeg', 0.9);
          
          // Show capture flash effect
          this.showCaptureFlash();
          
          // Create enhanced thumbnail
          this.addPhotoToPreview(photoDataUrl);

          // Store photo data
          this.photos.push({
            dataUrl: photoDataUrl,
            timestamp: new Date().toISOString(),
            shotNumber: this.shotsTaken + 1
          });
          
          this.shotsTaken++;
          this.updateProgress();
          this.updateShotIndicators();
          
          // Update UI
          this.captureButton.style.display = 'none';
          
          if (this.shotsTaken < this.shotsToTake) {
            this.countdownEl.textContent = `Great shot! Preparing for next photo...`;
            this.showStatus(`Photo ${this.shotsTaken} captured! ${this.shotsToTake - this.shotsTaken} more to go.`, 'success');
            setTimeout(() => {
              this.startCountdown();
            }, 2000);
          } else {
            this.completeSession();
          }
          
          console.log(`Photo ${this.shotsTaken} captured successfully`);
          
        } catch (error) {
          console.error('Error capturing photo:', error);
          this.showError('Failed to capture photo. Please try again.');
        }
      }

      addPhotoToPreview(photoDataUrl) {
        // Clear empty state
        if (this.photoPreview.classList.contains('photo-preview-empty')) {
          this.photoPreview.classList.remove('photo-preview-empty');
          this.photoPreview.innerHTML = '';
        }

        const photoItem = document.createElement('img');
        photoItem.src = photoDataUrl;
        photoItem.alt = `Photo ${this.shotsTaken + 1}`;
        photoItem.className = 'photo-preview-item';
        
        // Add with animation
        photoItem.style.transform = 'scale(0)';
        this.photoPreview.appendChild(photoItem);
        
        setTimeout(() => {
          photoItem.style.transform = 'scale(1)';
        }, 100);
      }

      completeSession() {
        this.countdownEl.textContent = 'üéâ Photo session complete!';
        this.captureButton.style.display = 'none';
        this.updateProgress();
        this.updateShotIndicators();
        
        // Store all photos in sessionStorage for editor
        const sessionData = {
          photos: this.photos,
          layout: this.selectedLayout,
          email: this.userEmail,
          timestamp: new Date().toISOString(),
          totalShots: this.shotsTaken
        };
        
        try {
          sessionStorage.setItem('photoboothSession', JSON.stringify(sessionData));
          console.log('Photo session data stored successfully');
        } catch (error) {
          console.error('Failed to store session data:', error);
          this.showError('Failed to save photos. Please try again.');
          return;
        }
        
        // Enable next button
        if (this.nextBtn) {
          this.nextBtn.disabled = false;
          this.nextBtn.innerHTML = 'üé® Continue to Editor';
        }
        
        this.showStatus(`All ${this.shotsTaken} photos captured successfully! Click "Continue to Editor" to create your photo strip.`, 'success');
        
        // Stop camera stream to save resources
        if (this.stream) {
          this.stream.getTracks().forEach(track => track.stop());
          this.video.style.opacity = '0.5';
          const switchBtn = document.getElementById('switch-camera-btn');
          if (switchBtn) switchBtn.style.display = 'none';
        }
      }

      showCaptureFlash() {
        const flash = document.getElementById('cameraFlash');
        flash.style.opacity = '0.8';
        setTimeout(() => {
          flash.style.opacity = '0';
        }, 200);
      }

      async switchCamera() {
        if (!this.isInitialized) return;

        try {
          // Stop current stream
          if (this.stream) {
            this.stream.getTracks().forEach(track => track.stop());
          }

          // Toggle between front and back camera
          const currentFacingMode = this.constraints.video.facingMode;
          this.constraints.video.facingMode = currentFacingMode === 'user' ? 'environment' : 'user';

          // Restart camera with new constraints
          this.stream = await navigator.mediaDevices.getUserMedia(this.constraints);
          this.video.srcObject = this.stream;
          
          this.showStatus(`Switched to ${this.constraints.video.facingMode === 'user' ? 'front' : 'back'} camera`, 'info');
          
        } catch (error) {
          console.error('Error switching camera:', error);
          this.showError('Unable to switch camera. This device may only have one camera.');
          
          // Revert to previous facing mode
          this.constraints.video.facingMode = this.constraints.video.facingMode === 'user' ? 'environment' : 'user';
        }
      }

      proceedToEditor() {
        const sessionData = sessionStorage.getItem('photoboothSession');
        if (!sessionData) {
          this.showError('No photo data found. Please retake photos.');
          return;
        }
        
        try {
          window.location.href = 'editor.html';
        } catch (error) {
          console.error('Navigation error:', error);
          this.showError('Unable to proceed to editor. Please try again.');
        }
      }

      showStatus(message, type = 'info') {
        if (this.statusMessage) {
          this.statusMessage.textContent = message;
          this.statusMessage.className = `status-message ${type}`;
          this.statusMessage.style.display = 'block';
          
          // Auto-hide after 5 seconds
          setTimeout(() => {
            this.statusMessage.style.display = 'none';
          }, 5000);
        }
        console.log(`Status (${type}):`, message);
      }

      showError(message) {
        this.showStatus(message, 'error');
      }

      destroy() {
        if (this.stream) {
          this.stream.getTracks().forEach(track => track.stop());
        }
        
        if (this.video) {
          this.video.srcObject = null;
        }
        
        this.isInitialized = false;
        console.log('Enhanced camera resources cleaned up');
      }
    }

    // Initialize when DOM is loaded
    document.addEventListener("DOMContentLoaded", () => {
      window.enhancedCamera = new EnhancedPhotoboothCamera();
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (window.enhancedCamera) {
        window.enhancedCamera.destroy();
      }
    });
  </script>
</body>
</html>